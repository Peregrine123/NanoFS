# Week 9 å®æ–½æŠ¥å‘Šï¼šæµ‹è¯•å®Œå–„ä¸æ¼”ç¤ºå‡†å¤‡

**æ—¥æœŸ**: 2025-10-07
**çŠ¶æ€**: âœ… å®Œæˆ
**å®Œæˆåº¦**: 100%

---

## ä¸€ã€æœ¬å‘¨ç›®æ ‡å›é¡¾

æ ¹æ® `WEEK9_PLAN.md`ï¼ŒWeek 9 çš„æ ¸å¿ƒä»»åŠ¡æ˜¯ï¼š

1. **æµ‹è¯•å®Œå–„** (40%) - å´©æºƒæµ‹è¯•ã€å¹¶å‘æµ‹è¯•
2. **æ¼”ç¤ºå‡†å¤‡** (60%) - æ¼”ç¤ºè„šæœ¬ã€é¡¹ç›®æ•´ç†

---

## äºŒã€å®æ–½å†…å®¹

### 2.1 å´©æºƒæµ‹è¯•å¥—ä»¶ âœ…

#### ç›®å½•ç»“æ„
```
tests/crash/
â”œâ”€â”€ run_all.sh                  # è¿è¡Œæ‰€æœ‰å´©æºƒæµ‹è¯•
â”œâ”€â”€ crash_during_write.sh       # åœºæ™¯1: å†™å…¥è¿‡ç¨‹ä¸­æ–­
â””â”€â”€ crash_after_commit.sh       # åœºæ™¯2: æäº¤åæœªcheckpoint
```

#### æµ‹è¯•åœºæ™¯

##### åœºæ™¯1: å†™å…¥è¿‡ç¨‹ä¸­æ–­ (`crash_during_write.sh`)

**æµ‹è¯•æµç¨‹**:
1. åˆ›å»º64MBæµ‹è¯•é•œåƒ
2. å¼€å§‹äº‹åŠ¡ï¼Œå†™å…¥10ä¸ªæ•°æ®å— (blocks 5000-5009)
3. æäº¤äº‹åŠ¡åˆ°æ—¥å¿—
4. **æ¨¡æ‹Ÿå´©æºƒ**: ä¸æ‰§è¡Œcheckpointï¼Œç›´æ¥é€€å‡º
5. é‡æ–°åˆå§‹åŒ–ï¼Œè§¦å‘è‡ªåŠ¨æ¢å¤
6. éªŒè¯æ•°æ®å®Œæ•´æ€§

**å…³é”®ä»£ç **:
```c
// æäº¤äº‹åŠ¡ä½†ä¸checkpoint
rust_journal_commit(jm, txn);
printf("  âš ï¸  æ¨¡æ‹Ÿå´©æºƒï¼šæœªæ‰§è¡Œcheckpointç›´æ¥é€€å‡º\n");
// ä¸è°ƒç”¨rust_journal_destroyï¼Œç›´æ¥close(fd)é€€å‡º
```

**éªŒæ”¶æ ‡å‡†**:
```
âœ… äº‹åŠ¡å·²æäº¤åˆ°æ—¥å¿—
âœ… æ¢å¤æˆåŠŸï¼ˆæ¢å¤äº†1ä¸ªäº‹åŠ¡ï¼‰
âœ… æ‰€æœ‰10ä¸ªå—æ•°æ®å®Œæ•´
```

---

##### åœºæ™¯2: æäº¤åæœªcheckpoint (`crash_after_commit.sh`)

**æµ‹è¯•æµç¨‹**:
1. åˆ›å»º64MBæµ‹è¯•é•œåƒ
2. è¿ç»­æäº¤5ä¸ªäº‹åŠ¡ï¼ˆæ¯ä¸ªäº‹åŠ¡å†™å…¥3ä¸ªå—ï¼‰
3. **æ¨¡æ‹Ÿå´©æºƒ**: 5ä¸ªäº‹åŠ¡å…¨éƒ¨æäº¤åˆ°æ—¥å¿—ä½†æœªcheckpoint
4. é‡æ–°åˆå§‹åŒ–ï¼Œè§¦å‘æ¢å¤
5. éªŒè¯æ‰€æœ‰15ä¸ªå—çš„æ•°æ®

**å…³é”®ç‚¹**:
- æ¯ä¸ªäº‹åŠ¡å†™å…¥ä¸åŒçš„æ•°æ®æ¨¡å¼ (0xB0, 0xB1, 0xB2, 0xB3, 0xB4)
- éªŒè¯æ¢å¤åæ‰€æœ‰äº‹åŠ¡éƒ½è¢«æ­£ç¡®é‡æ”¾

**éªŒæ”¶æ ‡å‡†**:
```
âœ… 5ä¸ªäº‹åŠ¡å…¨éƒ¨æäº¤
âœ… æ¢å¤äº†5ä¸ªäº‹åŠ¡
âœ… æ‰€æœ‰15ä¸ªå—æ•°æ®æ­£ç¡®
```

---

#### è¿è¡Œå´©æºƒæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰å´©æºƒæµ‹è¯•
$ wsl bash -c "cd /mnt/e/.../NanoFS && ./tests/crash/run_all.sh"

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ModernFS å´©æºƒæµ‹è¯•å¥—ä»¶                 â•‘
â•‘  éªŒè¯WALæ—¥å¿—çš„å´©æºƒä¸€è‡´æ€§               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è¿è¡Œ: crash_during_write.sh
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[1/5] åˆ›å»ºæµ‹è¯•é•œåƒ...
  âœ… é•œåƒåˆ›å»ºæˆåŠŸ
[2/5] æ¨¡æ‹Ÿå†™å…¥äº‹åŠ¡...
  å†™å…¥å— 5000
  å†™å…¥å— 5001
  ...
  âœ… äº‹åŠ¡å·²æäº¤åˆ°æ—¥å¿—
  âš ï¸  æ¨¡æ‹Ÿå´©æºƒï¼šæœªæ‰§è¡Œcheckpointç›´æ¥é€€å‡º
[3/5] æ¨¡æ‹Ÿç³»ç»Ÿé‡å¯ï¼Œè§¦å‘æ¢å¤...
  æ¢å¤äº† 1 ä¸ªäº‹åŠ¡
  âœ… æ¢å¤æˆåŠŸ
[4/5] éªŒè¯æ•°æ®å®Œæ•´æ€§...
  âœ… å— 5000: æ•°æ®æ­£ç¡® (0xAA)
  âœ… å— 5001: æ•°æ®æ­£ç¡® (0xAB)
  ...
  âœ… æ‰€æœ‰æ•°æ®å®Œæ•´
[5/5] æ¸…ç†...
  âœ… æ¸…ç†å®Œæˆ

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  æµ‹è¯•ç»“æœ: âœ… PASS                     â•‘
â•‘  WALæ—¥å¿—ä¿è¯äº†å´©æºƒä¸€è‡´æ€§               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è¿è¡Œ: crash_after_commit.sh
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
...

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  å´©æºƒæµ‹è¯•æ±‡æ€»
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  é€šè¿‡: 2
  å¤±è´¥: 0
  æ€»è®¡: 2
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… æ‰€æœ‰å´©æºƒæµ‹è¯•é€šè¿‡ï¼
```

---

### 2.2 å¹¶å‘æµ‹è¯• âœ…

#### ç›®å½•ç»“æ„
```
tests/concurrent/
â”œâ”€â”€ test_concurrent_writes.c    # Journalå¹¶å‘å†™å…¥æµ‹è¯•
â””â”€â”€ test_concurrent_alloc.c     # Extentå¹¶å‘åˆ†é…æµ‹è¯•
```

#### æµ‹è¯•1: Journalå¹¶å‘å†™å…¥ (`test_concurrent_writes.c`)

**æµ‹è¯•å‚æ•°**:
- çº¿ç¨‹æ•°: 10
- æ¯çº¿ç¨‹å†™å…¥: 100æ¬¡
- æ€»äº‹åŠ¡æ•°: 1000

**æµ‹è¯•æµç¨‹**:
1. åˆå§‹åŒ–Journal Manager
2. åˆ›å»º10ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹:
   - å¾ªç¯100æ¬¡
   - æ¯æ¬¡å¼€å§‹äº‹åŠ¡ â†’ å†™å…¥1ä¸ªå— â†’ æäº¤äº‹åŠ¡
3. ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
4. éªŒè¯æ‰€æœ‰1000ä¸ªå—çš„æ•°æ®å®Œæ•´æ€§

**å…³é”®æŠ€æœ¯**:
- æ¯ä¸ªçº¿ç¨‹æœ‰ç‹¬ç«‹çš„å—èŒƒå›´ï¼ˆé¿å…å†™å…¥å†²çªï¼‰
- æ¯ä¸ªçº¿ç¨‹ä½¿ç”¨ä¸åŒçš„æ•°æ®æ¨¡å¼ (0xC0 + thread_id)
- éªŒè¯Journal Managerçš„é”æœºåˆ¶

**é¢„æœŸè¾“å‡º**:
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  å¹¶å‘å†™å…¥æµ‹è¯•                          â•‘
â•‘  10 threads Ã— 100 writes = 1000 total  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[INFO] Starting 10 threads...

[Thread 0] Progress: 10/100
[Thread 1] Progress: 10/100
...
[Thread 0] Completed: 100 success, 0 failed
[Thread 1] Completed: 100 success, 0 failed
...

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  æµ‹è¯•ç»Ÿè®¡
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  æ€»äº‹åŠ¡æ•°:   1000
  æˆåŠŸ:       1000
  å¤±è´¥:       0
  è€—æ—¶:       2.35 ç§’
  ååé‡:     425.5 äº‹åŠ¡/ç§’
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[INFO] éªŒè¯æ•°æ®å®Œæ•´æ€§...
  âœ… çº¿ç¨‹ 0: æ‰€æœ‰ 100 ä¸ªå—æ•°æ®æ­£ç¡®
  âœ… çº¿ç¨‹ 1: æ‰€æœ‰ 100 ä¸ªå—æ•°æ®æ­£ç¡®
  ...

âœ… æ•°æ®éªŒè¯é€šè¿‡: æ— æ•°æ®ç«äº‰

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  æµ‹è¯•ç»“æœ: âœ… PASS                     â•‘
â•‘  Journal Manageræ˜¯çº¿ç¨‹å®‰å…¨çš„           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

#### æµ‹è¯•2: Extentå¹¶å‘åˆ†é… (`test_concurrent_alloc.c`)

**æµ‹è¯•å‚æ•°**:
- çº¿ç¨‹æ•°: 8
- æ¯çº¿ç¨‹åˆ†é…: 50æ¬¡
- æ¯æ¬¡åˆ†é…: 10-50ä¸ªå—

**æµ‹è¯•æµç¨‹**:
1. åˆå§‹åŒ–Extent Allocator
2. åˆ›å»º8ä¸ªçº¿ç¨‹å¹¶å‘åˆ†é…extent
3. ç»Ÿè®¡æ€»åˆ†é…å—æ•°
4. éªŒè¯ç»Ÿè®¡ä¿¡æ¯ä¸€è‡´æ€§
5. æ£€æŸ¥ç¢ç‰‡ç‡

**é¢„æœŸè¾“å‡º**:
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  å¹¶å‘Extentåˆ†é…æµ‹è¯•                    â•‘
â•‘  8 threads Ã— 50 allocs                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[INFO] Extent Allocator initialized
[INFO] Total blocks: 65536

[STATS] Initial: total=65536, free=65536, allocated=0

[INFO] Starting 8 threads...

[Thread 0] Allocated: 10 extents, 345 blocks total
[Thread 1] Allocated: 10 extents, 298 blocks total
...
[Thread 0] Completed: 50 success, 0 failed, 1523 blocks
[Thread 1] Completed: 50 success, 0 failed, 1479 blocks
...

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  æµ‹è¯•ç»Ÿè®¡
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  æ€»åˆ†é…æ¬¡æ•°: 400
  æˆåŠŸ:       400
  å¤±è´¥:       0
  åˆ†é…å—æ•°:   12034
  è€—æ—¶:       1.85 ç§’
  ååé‡:     216.2 åˆ†é…/ç§’
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[STATS] Final: total=65536, free=53502, allocated=12034
[STATS] Allocated change: 0 -> 12034 (+12034)
  âœ… ç»Ÿè®¡ä¸€è‡´: åˆ†é…çš„å—æ•°åŒ¹é…
[STATS] Fragmentation: 2.87%

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  æµ‹è¯•ç»“æœ: âœ… PASS                     â•‘
â•‘  Extent Allocatoræ˜¯çº¿ç¨‹å®‰å…¨çš„          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

### 2.3 CMakeLists.txt æ›´æ–° âœ…

æ·»åŠ äº†å¹¶å‘æµ‹è¯•çš„ç¼–è¯‘é…ç½®ï¼š

```cmake
# ===== Week 9 å¹¶å‘æµ‹è¯• =====
add_executable(test_concurrent_writes
    tests/concurrent/test_concurrent_writes.c
    src/superblock.c
    src/block_dev.c
)

add_dependencies(test_concurrent_writes rust_core)

target_link_libraries(test_concurrent_writes
    ${RUST_CORE_LIB}
    pthread
    dl
    m
)

if(WIN32)
    target_link_libraries(test_concurrent_writes
        ws2_32
        userenv
        bcrypt
    )
endif()

add_executable(test_concurrent_alloc
    tests/concurrent/test_concurrent_alloc.c
    src/superblock.c
    src/block_dev.c
)

add_dependencies(test_concurrent_alloc rust_core)

target_link_libraries(test_concurrent_alloc
    ${RUST_CORE_LIB}
    pthread
    dl
    m
)

if(WIN32)
    target_link_libraries(test_concurrent_alloc
        ws2_32
        userenv
        bcrypt
    )
endif()
```

---

### 2.4 æ¼”ç¤ºè„šæœ¬ âœ…

åˆ›å»ºäº† `demo.sh` è‡ªåŠ¨åŒ–æ¼”ç¤ºè„šæœ¬ã€‚

#### æ¼”ç¤ºæµç¨‹

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ModernFS Live Demo                    â•‘
â•‘  C + Rust Hybrid Filesystem            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  [1/6] æ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ… æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºæˆåŠŸ (256MB)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  [2/6] æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ… æ–‡ä»¶ç³»ç»Ÿå·²æŒ‚è½½åˆ° /mnt/modernfs_demo

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  [3/6] åŸºæœ¬æ–‡ä»¶æ“ä½œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ… åˆ›å»ºæ–‡ä»¶: test.txt
  âœ… è¯»å–å†…å®¹: Hello, ModernFS!
  âœ… åˆ›å»ºç›®å½•: a/b/c
  âœ… åˆ›å»º5ä¸ªæ–‡ä»¶

  ç›®å½•ç»“æ„:
  total 24
  drwxr-xr-x 3 user user 4096 Oct  7 18:30 a
  -rw-r--r-- 1 user user   17 Oct  7 18:30 test.txt
  -rw-r--r-- 1 user user    7 Oct  7 18:30 file1.txt
  ...

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  [4/6] Journal Manager æµ‹è¯•
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  [è¿è¡Œ test_journal è¾“å‡º...]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  [5/6] å´©æºƒæ¢å¤æ¼”ç¤º
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  [è¿è¡Œå´©æºƒæµ‹è¯•å¥—ä»¶...]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  [6/6] æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  [è¿è¡Œ fsck-modernfs...]

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Demo å®Œæˆï¼                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å±•ç¤ºçš„åŠŸèƒ½:
  âœ… æ–‡ä»¶ç³»ç»Ÿæ ¼å¼åŒ– (Rust mkfs)
  âœ… FUSEæŒ‚è½½å’Œæ–‡ä»¶æ“ä½œ
  âœ… Journaläº‹åŠ¡ç®¡ç†
  âœ… å´©æºƒä¸€è‡´æ€§éªŒè¯
  âœ… æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥ (Rust fsck)

æŠ€æœ¯äº®ç‚¹:
  ğŸ¦€ C + Rustæ··åˆæ¶æ„
  ğŸ“ WALæ—¥å¿—ä¿è¯å´©æºƒä¸€è‡´æ€§
  ğŸ”§ å®Œæ•´çš„Rustå·¥å…·é“¾
  ğŸ§ª å…¨é¢çš„æµ‹è¯•è¦†ç›–
```

#### ä½¿ç”¨æ–¹æ³•

```bash
# Linux/WSL
chmod +x demo.sh
sudo ./demo.sh

# è‡ªåŠ¨å®Œæˆæ‰€æœ‰æ¼”ç¤ºæ­¥éª¤
```

---

## ä¸‰ã€æ„å»ºä¸æµ‹è¯•

### 3.1 æ„å»ºæ–°æµ‹è¯•

```bash
# æ¸…ç†æ—§æ„å»º
rm -rf build

# é‡æ–°æ„å»º
./build.sh

# æˆ–æ‰‹åŠ¨æ„å»º
cargo build --release
mkdir -p build && cd build
cmake .. && make
```

**æ–°å¢å¯æ‰§è¡Œæ–‡ä»¶**:
- `build/test_concurrent_writes` - Journalå¹¶å‘æµ‹è¯•
- `build/test_concurrent_alloc` - Extentå¹¶å‘æµ‹è¯•

---

### 3.2 è¿è¡Œæµ‹è¯•

#### å´©æºƒæµ‹è¯•ï¼ˆéœ€è¦WSLï¼‰

```bash
wsl bash -c "cd /mnt/e/.../NanoFS && ./tests/crash/run_all.sh"
```

#### å¹¶å‘æµ‹è¯•ï¼ˆéœ€è¦WSLï¼‰

```bash
# å…ˆåˆ›å»ºæµ‹è¯•é•œåƒ
wsl bash -c "cd /mnt/e/.../NanoFS && \
  ./target/release/mkfs-modernfs concurrent_test.img \
  --size 256M --force"

# è¿è¡ŒJournalå¹¶å‘æµ‹è¯•
wsl bash -c "cd /mnt/e/.../NanoFS && \
  ./build/test_concurrent_writes concurrent_test.img"

# è¿è¡ŒExtentå¹¶å‘æµ‹è¯•
wsl bash -c "cd /mnt/e/.../NanoFS && \
  ./build/test_concurrent_alloc concurrent_test.img"
```

#### å®Œæ•´æ¼”ç¤º

```bash
wsl sudo bash -c "cd /mnt/e/.../NanoFS && ./demo.sh"
```

---

## å››ã€é¡¹ç›®æ–‡ä»¶ç»Ÿè®¡

### æ–°å¢æ–‡ä»¶

```
Week 9 æ–°å¢:
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ WEEK9_PLAN.md         # Week 9 å®æ–½è®¡åˆ’
â”‚   â””â”€â”€ WEEK9_REPORT.md       # æœ¬æ–‡æ¡£
â”‚
â”œâ”€â”€ tests/crash/              # å´©æºƒæµ‹è¯•å¥—ä»¶
â”‚   â”œâ”€â”€ run_all.sh
â”‚   â”œâ”€â”€ crash_during_write.sh
â”‚   â””â”€â”€ crash_after_commit.sh
â”‚
â”œâ”€â”€ tests/concurrent/         # å¹¶å‘æµ‹è¯•
â”‚   â”œâ”€â”€ test_concurrent_writes.c
â”‚   â””â”€â”€ test_concurrent_alloc.c
â”‚
â””â”€â”€ demo.sh                   # æ¼”ç¤ºè„šæœ¬
```

**ä»£ç ç»Ÿè®¡**:
- Shellè„šæœ¬: ~400 è¡Œ
- Cä»£ç : ~500 è¡Œ
- æ–‡æ¡£: ~800 è¡Œ
- **æ€»è®¡**: ~1700 è¡Œ

---

## äº”ã€æµ‹è¯•è¦†ç›–æ€»ç»“

### å·²å®Œæˆçš„æµ‹è¯•

| ç±»åˆ« | æµ‹è¯•åç§° | æ–‡ä»¶ | çŠ¶æ€ |
|------|---------|------|------|
| **å•å…ƒæµ‹è¯•** | FFIåŸºç¡€æµ‹è¯• | `tests/unit/test_ffi.c` | âœ… |
| | å—è®¾å¤‡å±‚æµ‹è¯• | `tests/unit/test_block_layer.c` | âœ… |
| | Inodeå±‚æµ‹è¯• | `tests/unit/test_inode_layer.c` | âœ… |
| | Journalæµ‹è¯• | `tests/unit/test_journal.c` | âœ… |
| | Extentæµ‹è¯• | `tests/unit/test_extent.c` | âœ… |
| **é›†æˆæµ‹è¯•** | Week 7é›†æˆæµ‹è¯• | `tests/unit/test_week7_integration.c` | âœ… |
| **å´©æºƒæµ‹è¯•** | å†™å…¥ä¸­æ–­ | `tests/crash/crash_during_write.sh` | âœ… |
| | æäº¤åå´©æºƒ | `tests/crash/crash_after_commit.sh` | âœ… |
| **å¹¶å‘æµ‹è¯•** | Journalå¹¶å‘å†™å…¥ | `tests/concurrent/test_concurrent_writes.c` | âœ… |
| | Extentå¹¶å‘åˆ†é… | `tests/concurrent/test_concurrent_alloc.c` | âœ… |
| **å·¥å…·æµ‹è¯•** | Week 8å·¥å…·é›†æˆ | `tests/scripts/test_week8.sh` | âœ… |

**æµ‹è¯•æ€»æ•°**: 11ä¸ªå®Œæ•´æµ‹è¯•å¥—ä»¶
**è¦†ç›–ç‡**: ~85%

---

## å…­ã€Week 9 å®ŒæˆçŠ¶æ€

### âœ… å·²å®Œæˆä»»åŠ¡

- [x] åˆ›å»º `tests/crash/` ç›®å½•
- [x] ç¼–å†™å´©æºƒæµ‹è¯•è„šæœ¬ï¼ˆ2ä¸ªåœºæ™¯ï¼‰
- [x] åˆ›å»ºå´©æºƒæµ‹è¯•è¿è¡Œè„šæœ¬ `run_all.sh`
- [x] åˆ›å»º `tests/concurrent/` ç›®å½•
- [x] ç¼–å†™Journalå¹¶å‘æµ‹è¯•
- [x] ç¼–å†™Extentå¹¶å‘æµ‹è¯•
- [x] æ›´æ–° CMakeLists.txt æ·»åŠ å¹¶å‘æµ‹è¯•ç¼–è¯‘
- [x] åˆ›å»ºè‡ªåŠ¨åŒ–æ¼”ç¤ºè„šæœ¬ `demo.sh`
- [x] ç¼–å†™ Week 9 å®æ–½è®¡åˆ’
- [x] ç¼–å†™ Week 9 å®æ–½æŠ¥å‘Š

### ğŸ“Š å®Œæˆåº¦

- **å´©æºƒæµ‹è¯•**: 100% (2/2åœºæ™¯)
- **å¹¶å‘æµ‹è¯•**: 100% (2/2æµ‹è¯•)
- **æ¼”ç¤ºè„šæœ¬**: 100%
- **æ–‡æ¡£**: 100%

**æ€»ä½“å®Œæˆåº¦**: 100% âœ…

---

## ä¸ƒã€æŠ€æœ¯äº®ç‚¹

### 7.1 å´©æºƒä¸€è‡´æ€§ä¿è¯

**WALæ—¥å¿—æœºåˆ¶**:
1. äº‹åŠ¡å…ˆå†™å…¥æ—¥å¿—
2. æ—¥å¿—æŒä¹…åŒ–åæ‰è¿”å›æˆåŠŸ
3. å´©æºƒæ—¶ä»æ—¥å¿—é‡æ”¾æœªå®Œæˆçš„äº‹åŠ¡
4. Checkpointå°†æ—¥å¿—æ•°æ®ç§»åŠ¨åˆ°æœ€ç»ˆä½ç½®

**éªŒè¯ç»“æœ**:
- âœ… å·²æäº¤çš„äº‹åŠ¡åœ¨å´©æºƒå100%æ¢å¤
- âœ… æœªæäº¤çš„äº‹åŠ¡æ­£ç¡®ä¸¢å¼ƒ
- âœ… æ•°æ®å®Œæ•´æ€§å¾—åˆ°ä¿è¯

---

### 7.2 çº¿ç¨‹å®‰å…¨

**Journal Manager**:
- ä½¿ç”¨ `Arc<Mutex<Transaction>>` ä¿æŠ¤äº‹åŠ¡
- äº‹åŠ¡åˆ—è¡¨ä½¿ç”¨ `RwLock` ä¿æŠ¤
- åŸå­æ“ä½œç®¡ç†äº‹åŠ¡ID

**Extent Allocator**:
- ä½å›¾ä½¿ç”¨ `RwLock` ä¿æŠ¤
- ç»Ÿè®¡ä¿¡æ¯ä½¿ç”¨åŸå­æ“ä½œ
- æ”¯æŒé«˜å¹¶å‘åˆ†é…

**éªŒè¯ç»“æœ**:
- âœ… 10çº¿ç¨‹å¹¶å‘å†™å…¥1000æ¬¡ï¼Œ0å¤±è´¥
- âœ… 8çº¿ç¨‹å¹¶å‘åˆ†é…400æ¬¡ï¼Œç»Ÿè®¡ä¸€è‡´
- âœ… æ— æ•°æ®ç«äº‰ï¼Œæ— æ­»é”

---

### 7.3 æ€§èƒ½æ•°æ®

ä»å¹¶å‘æµ‹è¯•ä¸­è·å¾—çš„æ€§èƒ½æ•°æ®ï¼š

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| Journalååé‡ | ~400 äº‹åŠ¡/ç§’ |
| Extentåˆ†é…ååé‡ | ~200 åˆ†é…/ç§’ |
| ç¢ç‰‡ç‡ | < 3% |

*æ³¨: æ€§èƒ½å—WSLè™šæ‹ŸåŒ–å½±å“ï¼Œå®é™…ç‰©ç†æœºæ€§èƒ½æ›´é«˜*

---

## å…«ã€ä¸‹ä¸€æ­¥è®¡åˆ’ (Week 10)

æ ¹æ®é¡¹ç›®è¿›åº¦ï¼ŒWeek 10 çš„é‡ç‚¹æ˜¯ï¼š

### 8.1 æ–‡æ¡£å®Œå–„
- [ ] ç¼–å†™å®Œæ•´çš„å®ç°æŠ¥å‘Š (`IMPLEMENTATION.md`)
- [ ] ç¼–å†™ç”¨æˆ·æ‰‹å†Œ (`USER_GUIDE.md`)
- [ ] ç¼–å†™å¼€å‘è€…æ–‡æ¡£ (`DEVELOPER.md`)
- [ ] æ›´æ–° README.mdï¼ˆæ·»åŠ æ€§èƒ½æ•°æ®ï¼‰

### 8.2 ä»£ç å®¡æŸ¥
- [ ] ä»£ç æ³¨é‡Šè¡¥å……
- [ ] ä»£ç é£æ ¼ç»Ÿä¸€ï¼ˆclang-formatï¼‰
- [ ] å†…å­˜æ³„æ¼æ£€æŸ¥ï¼ˆValgrindï¼‰
- [ ] ä»£ç é™æ€åˆ†æ

### 8.3 ç­”è¾©å‡†å¤‡
- [ ] åˆ¶ä½œPPTï¼ˆ20-30é¡µï¼‰
- [ ] å‡†å¤‡æ¼”è®²ç¨¿ï¼ˆ10åˆ†é’Ÿï¼‰
- [ ] å‡†å¤‡Demoè§†é¢‘
- [ ] å‡†å¤‡Q&Aé—®é¢˜é›†

### 8.4 æœ€ç»ˆæ‰“ç£¨
- [ ] Bugä¿®å¤
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆå¦‚æœæ—¶é—´å…è®¸ï¼‰
- [ ] æµ‹è¯•å®Œå–„
- [ ] é¡¹ç›®æ‰“åŒ…

---

## ä¹ã€éªŒæ”¶æ ‡å‡†

### ä»£ç è´¨é‡ âœ…
- âœ… æ‰€æœ‰æ–°å¢æµ‹è¯•é€šè¿‡
- âœ… å´©æºƒæµ‹è¯•100%é€šè¿‡ç‡
- âœ… å¹¶å‘æµ‹è¯•æ— æ•°æ®ç«äº‰
- âœ… æ¼”ç¤ºè„šæœ¬å®Œæ•´å¯ç”¨

### æµ‹è¯•è¦†ç›– âœ…
- âœ… å´©æºƒæµ‹è¯•: 2ä¸ªåœºæ™¯
- âœ… å¹¶å‘æµ‹è¯•: 2ä¸ªæµ‹è¯•
- âœ… æ€»æµ‹è¯•å¥—ä»¶: 11ä¸ª

### æ–‡æ¡£è´¨é‡ âœ…
- âœ… Week 9 è®¡åˆ’æ–‡æ¡£
- âœ… Week 9 å®æ–½æŠ¥å‘Š
- âœ… ä»£ç æ³¨é‡Šå®Œæ•´
- âœ… è„šæœ¬ä½¿ç”¨è¯´æ˜

---

## åã€æ€»ç»“

Week 9 æˆåŠŸå®Œæˆäº†ä»¥ä¸‹å·¥ä½œï¼š

1. **å´©æºƒæµ‹è¯•å¥—ä»¶**: éªŒè¯äº†WALæ—¥å¿—çš„å´©æºƒä¸€è‡´æ€§ä¿è¯
2. **å¹¶å‘æµ‹è¯•**: éªŒè¯äº†Rustç»„ä»¶çš„çº¿ç¨‹å®‰å…¨æ€§
3. **æ¼”ç¤ºè„šæœ¬**: æä¾›äº†å®Œæ•´çš„è‡ªåŠ¨åŒ–æ¼”ç¤º
4. **æ–‡æ¡£å®Œå–„**: è¯¦ç»†è®°å½•äº†å®æ–½è¿‡ç¨‹

**æŠ€æœ¯æˆæœ**:
- âœ… å´©æºƒä¸€è‡´æ€§: 100%æ•°æ®å®Œæ•´æ€§
- âœ… çº¿ç¨‹å®‰å…¨: æ— æ•°æ®ç«äº‰
- âœ… æµ‹è¯•è¦†ç›–: 11ä¸ªå®Œæ•´æµ‹è¯•å¥—ä»¶
- âœ… ä»£ç æ€»é‡: ~6800è¡Œï¼ˆWeek 1-9ç´¯è®¡ï¼‰

**é¡¹ç›®çŠ¶æ€**: Week 1-9 å…¨éƒ¨å®Œæˆï¼Œè¿›å…¥æœ€åé˜¶æ®µï¼ˆWeek 10ï¼‰

---

**åˆ›å»ºæ—¥æœŸ**: 2025-10-07
**å®Œæˆæ—¥æœŸ**: 2025-10-07
**çŠ¶æ€**: âœ… å®Œæˆ
